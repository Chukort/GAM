<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Dilaab Camp Master List</title>
    <link rel="stylesheet" href="reg.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

    <div class="container" style="max-width: 1000px;">
        <div class="header" style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 25px; border-bottom: 1px solid var(--border); padding-bottom: 15px;">
            <div>
                <h2>Dilaab Camp 2026</h2>
                <p>Cloud Master Database</p>
            </div>
            <div class="stats-badge" style="background: var(--input-bg); padding: 12px 24px; border-radius: 14px; border: 1px solid var(--border); font-weight: 800; font-size: 1.1rem;">
                TOTAL: <span id="totalCount" style="color: var(--primary);">0</span>
            </div>
        </div>

        <div class="admin-controls">
            <label>Filter by Church</label>
            <div class="tabs-container" id="tabsList" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 25px;">
                </div>

            <div class="search-actions" style="display: flex; gap: 12px; margin-bottom: 25px; align-items: center; flex-wrap: wrap;">
                <input type="text" id="searchInput" placeholder="Search participant name..." onkeyup="filterAndRender()" style="flex: 2; min-width: 250px;">
                
                <div style="display: flex; gap: 10px; flex: 1; min-width: 250px;">
                    <button class="btn" style="background: #10b981;" onclick="downloadPDF()">üìÑ Export PDF</button>
                    <button class="btn" style="background: #3b82f6;" onclick="fetchCloudData()">üîÑ Refresh</button>
                </div>
            </div>
        </div>

        <div class="table-responsive" style="background: rgba(0,0,0,0.2); border-radius: 16px; border: 1px solid var(--border);">
            <table id="adminTable">
                <thead>
                    <tr>
                        <th style="width: 60px; text-align: center;">#</th>
                        <th>Church Name</th>
                        <th>Participant Name</th>
                        <th style="text-align: right;">Registration Date</th>
                    </tr>
                </thead>
                <tbody id="adminBody">
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 60px; color: var(--text-muted);">
                            Loading cloud database...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div style="margin-top: 30px; text-align: center; display: flex; justify-content: center; gap: 20px;">
            <a href="registration.html" style="color: var(--text-muted); text-decoration: none; font-size: 0.9rem; font-weight: 600;">
                ‚Üê Back to Registration
            </a>
        </div>
    </div>

    <script>
        // --- GITHUB CONFIGURATION ---
    const GITHUB_TOKEN = "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"; // Put your token here
    const OWNER = "Chukort";               // Put your GitHub username here
    const REPO = "GAM";               // Put your repo name here
    const FILE_PATH = "database.json";           // Same folder as this file

        let fullDatabase = []; // Stores all data from cloud
        let currentFilter = "All";

        /**
         * Fetches the latest data directly from GitHub Raw
         */
        async function fetchCloudData() {
            const body = document.getElementById('adminBody');
            const url = `https://raw.githubusercontent.com/${OWNER}/${REPO}/main/${FILE_PATH}?t=${new Date().getTime()}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("File not found");
                
                fullDatabase = await response.json();
                
                // Sort Alphabetically: Church first, then Name
                fullDatabase.sort((a, b) => {
                    if (a.church === b.church) return a.name.localeCompare(b.name);
                    return a.church.localeCompare(b.church);
                });

                renderTabs();
                filterAndRender();
            } catch (err) {
                console.error(err);
                body.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 40px; color: #ff4444;">
                    Error: Could not connect to GitHub database. Ensure database.json exists.
                </td></tr>`;
            }
        }

        function renderTabs() {
            const tabsList = document.getElementById('tabsList');
            const churches = ["All", ...new Set(fullDatabase.map(item => item.church))];
            
            tabsList.innerHTML = churches.map(church => `
                <button class="btn ${currentFilter === church ? '' : 'btn-add'}" 
                        style="width: auto; padding: 10px 18px; font-size: 0.85rem; margin: 0; 
                               ${currentFilter === church ? 'background: var(--primary); border-color: var(--primary);' : 'background: var(--input-bg);'}"
                        onclick="setFilter('${church}')">
                    ${church}
                </button>
            `).join('');
        }

        function setFilter(church) {
            currentFilter = church;
            renderTabs();
            filterAndRender();
        }

        function filterAndRender() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const body = document.getElementById('adminBody');
            
            const filteredData = fullDatabase.filter(item => {
                const matchesTab = (currentFilter === "All" || item.church === currentFilter);
                const matchesSearch = item.name.toLowerCase().includes(searchTerm);
                return matchesTab && matchesSearch;
            });

            document.getElementById('totalCount').innerText = filteredData.length;
            
            if (filteredData.length === 0) {
                body.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 60px; color: var(--text-muted);">No records found.</td></tr>`;
                return;
            }

            body.innerHTML = filteredData.map((item, i) => `
                <tr>
                    <td style="text-align: center; color: var(--text-muted);">${i + 1}</td>
                    <td><span style="color: var(--primary); font-weight: 700;">${item.church}</span></td>
                    <td style="text-transform: uppercase; font-weight: 500;">${item.name}</td>
                    <td style="text-align: right; color: var(--text-muted); font-size: 0.85rem;">${item.date}</td>
                </tr>
            `).join('');
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(20);
            doc.setTextColor(255, 31, 68);
            doc.text("DILAAB CAMP 2026", 14, 18);
            
            doc.setFontSize(12);
            doc.setTextColor(40, 40, 40);
            doc.text(`Master List: ${currentFilter}`, 14, 26);

            doc.autoTable({ 
                html: '#adminTable', 
                startY: 35,
                theme: 'striped',
                headStyles: { fillColor: [255, 31, 68] },
                styles: { fontSize: 9 }
            });

            doc.save(`Dilaab_MasterList_${currentFilter}.pdf`);
        }

        // Initialize on load
        window.onload = fetchCloudData;
    </script>
</body>
</html>