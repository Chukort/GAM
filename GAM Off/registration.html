<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dilaab Camp Registration</title>
    <link rel="stylesheet" href="reg.css">
</head>
<body>
g
<div class="container">
    <header>
        <h2>Dilaab Camp 2026</h2>
        <p>Register your delegation below.</p>
    </header>
    
    <div class="form-group" style="margin-bottom: 20px;">
        <label for="churchSelect">Local Church</label>
        <select id="churchSelect" onchange="toggleOtherChurch(this.value)">
            <option value="">-- Choose Local Church --</option>
            <option value="GAM CANLAON">GAM CANLAON</option>
            <option value="GAM SAN CARLOS">GAM SAN CARLOS</option>
            <option value="GAM PAMPLONA">GAM PAMPLONA</option>
            <option value="GAM SAN JOSE">GAM SAN JOSE</option>
            <option value="GAM DUMAGUETE">GAM DUMAGUETE</option>
            <option value="HOPE CITY - GAM">HOPE CITY - GAM</option>
            <option value="Other">Other (Specify below)</option>
        </select>
    </div>

    <div id="otherDiv" class="form-group hidden" style="margin-bottom: 20px;">
        <label for="customChurch">Specify Church Name</label>
        <input type="text" id="customChurch" placeholder="Type your church name here...">
    </div>

    <div id="list" class="form-group" style="margin-top: 25px;">
        <label>Delegation Participants</label>
        <div class="participant-entry">
            <input type="text" class="p-name" placeholder="Full Name (e.g. Juan Dela Cruz)" required>
            <div style="width: 48px; flex-shrink: 0;"></div>
        </div>
    </div>

    <div style="margin-top: 25px; display: flex; flex-direction: column; gap: 12px;">
        <button type="button" class="btn btn-add" id="addBtn" onclick="addRow()">+ Add Another Person</button>
        <button type="button" class="btn btn-submit" id="submitBtn" onclick="saveData()">Submit Registration</button>
    </div>
</div>

<div class="modal-overlay" id="successModal">
    <div class="modal-content">
        <span class="modal-icon">ðŸ”¥</span>
        <h2 style="background: none; -webkit-text-fill-color: var(--text-main); margin-bottom: 15px;">Registration Successful!</h2>
        <p style="color: var(--text-muted); margin-bottom: 20px;">Your delegation has been synced to the cloud master list.</p>
        
        <div style="padding: 20px; background: rgba(0,0,0,0.2); border-radius: 16px; border: 1px solid var(--border); margin-bottom: 25px;">
            <h3 style="color: white; margin: 0; letter-spacing: 2px;">DILAAB CAMP 2026</h3>
            <span class="theme-text">Theme: TUTOK</span>
            <span class="scripture-text">Hebrews 12:2</span>
        </div>
        
        <button class="btn btn-submit" onclick="closeModal()">Praise God!</button>
    </div>
</div>

<script>
    // --- GITHUB CONFIGURATION ---
    const GITHUB_TOKEN = "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"; 
    const OWNER = "Chukort"; 
    const REPO = "GAM"; 
    const FILE_PATH = "database.json"; 

    function toggleOtherChurch(value) {
        const otherDiv = document.getElementById('otherDiv');
        otherDiv.style.display = (value === 'Other') ? 'block' : 'none';
        if (value === 'Other') document.getElementById('customChurch').focus();
    }

    function addRow() {
        const list = document.getElementById('list');
        const div = document.createElement('div');
        div.className = 'participant-entry';
        div.style.marginTop = "12px";
        div.style.animation = "slideInLeft 0.3s ease-out";
        div.innerHTML = `
            <input type="text" class="p-name" placeholder="Full Name" required>
            <button class="btn btn-remove" onclick="this.parentElement.remove()" title="Remove Entry">âœ•</button>
        `;
        list.appendChild(div);
        div.querySelector('input').focus();
    }

    async function saveData() {
        const btn = document.getElementById('submitBtn');
        const churchSelect = document.getElementById('churchSelect');
        let church = churchSelect.value === 'Other' ? document.getElementById('customChurch').value.trim() : churchSelect.value;
        
        if (!church) {
            churchSelect.style.borderColor = 'var(--primary)';
            return alert("Please select or specify your Local Church.");
        }

        const nameInputs = document.querySelectorAll('.p-name');
        let newEntries = [];
        nameInputs.forEach(input => {
            if (input.value.trim()) {
                newEntries.push({
                    church: church.toUpperCase(),
                    name: input.value.trim().toUpperCase(),
                    date: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                });
            }
        });

        if (newEntries.length === 0) return alert("Please enter at least one participant.");

        btn.disabled = true;
        btn.innerText = "Connecting to Cloud...";

        try {
            // Using a timestamp to ensure we get the absolute latest version of the file (prevents SHA errors)
            const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}?t=${new Date().getTime()}`;
            
            // 1. Get current file data
            const res = await fetch(url, {
                headers: { 
                    "Authorization": `token ${GITHUB_TOKEN}`,
                    "Cache-Control": "no-cache" 
                }
            });

            if (!res.ok) throw new Error("Could not find the database file. Check your Repo name.");

            const fileData = await res.json();
            const sha = fileData.sha;
            // Robust Decode (Handles special characters like Ã‘ or accent marks)
            const currentData = JSON.parse(decodeURIComponent(escape(atob(fileData.content))));

            // 2. Merge data
            const updatedData = [...currentData, ...newEntries];
            
            // 3. Encode to Base64 (Unicode Safe)
            const jsonString = JSON.stringify(updatedData, null, 2);
            const updatedContent = btoa(unescape(encodeURIComponent(jsonString)));

            btn.innerText = "Uploading Data...";

            // 4. Update file on GitHub
            const putRes = await fetch(url, {
                method: "PUT",
                headers: {
                    "Authorization": `token ${GITHUB_TOKEN}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    message: `Registration from ${church}`,
                    content: updatedContent,
                    sha: sha
                })
            });

            const result = await putRes.json();

            if (putRes.ok) {
                document.getElementById('successModal').classList.add('active');
            } else {
                // Specific Error Messages
                if(result.message.includes("does not match")) {
                    throw new Error("Conflict: Someone else is registering at the same time. Please try again in 5 seconds.");
                }
                throw new Error(result.message || "GitHub rejected the update.");
            }

        } catch (err) {
            console.error(err);
            alert("Registration Failed: " + err.message);
            btn.disabled = false;
            btn.innerText = "Submit Registration";
        }
    }

    function closeModal() {
        document.getElementById('successModal').classList.remove('active');
        setTimeout(() => { location.reload(); }, 400);
    }
</script>

</body>
</html>

