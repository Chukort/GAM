<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dilaab Camp Registration</title>
    <link rel="stylesheet" href="reg.css">
</head>
<body>

<div class="container">
    <header>
        <h2>Dilaab Camp 2026</h2>
        <p>Register your delegation below.</p>
    </header>
    
    <div class="form-group" style="margin-bottom: 20px;">
        <label for="churchSelect">Local Church</label>
        <select id="churchSelect" onchange="toggleOtherChurch(this.value)">
            <option value="">-- Choose Local Church --</option>
            <option value="GAM CANLAON">GAM CANLAON</option>
            <option value="GAM SAN CARLOS">GAM SAN CARLOS</option>
            <option value="GAM PAMPLONA">GAM PAMPLONA</option>
            <option value="GAM SAN JOSE">GAM SAN JOSE</option>
            <option value="GAM DUMAGUETE">GAM DUMAGUETE</option>
            <option value="HOPE CITY - GAM">HOPE CITY - GAM</option>
            <option value="Other">Other (Specify below)</option>
        </select>
    </div>

    <div id="otherDiv" class="form-group hidden" style="margin-bottom: 20px;">
        <label for="customChurch">Specify Church Name</label>
        <input type="text" id="customChurch" placeholder="Type your church name here...">
    </div>

    <div id="list" class="form-group" style="margin-top: 25px;">
        <label>Delegation Participants</label>
        <div class="participant-entry">
            <input type="text" class="p-name" placeholder="Full Name (e.g. Juan Dela Cruz)" required>
            <div style="width: 48px; flex-shrink: 0;"></div>
        </div>
    </div>

    <div style="margin-top: 25px; display: flex; flex-direction: column; gap: 12px;">
        <button type="button" class="btn btn-add" id="addBtn" onclick="addRow()">+ Add Another Person</button>
        <button type="button" class="btn btn-submit" id="submitBtn" onclick="saveData()">Submit Registration</button>
    </div>
</div>

<div class="modal-overlay" id="successModal">
    <div class="modal-content">
        <span class="modal-icon">ðŸ”¥</span>
        <h2 style="background: none; -webkit-text-fill-color: var(--text-main); margin-bottom: 15px;">Registration Successful!</h2>
        <p style="color: var(--text-muted); margin-bottom: 20px;">Your delegation has been synced to the cloud master list.</p>
        
        <div style="padding: 20px; background: rgba(0,0,0,0.2); border-radius: 16px; border: 1px solid var(--border); margin-bottom: 25px;">
            <h3 style="color: white; margin: 0; letter-spacing: 2px;">DILAAB CAMP 2026</h3>
            <span class="theme-text">Theme: TUTOK</span>
            <span class="scripture-text">Hebrews 12:2</span>
        </div>
        
        <button class="btn btn-submit" onclick="closeModal()">Praise God!</button>
    </div>
</div>

<script>
    // --- GITHUB CONFIGURATION ---
    const GITHUB_TOKEN = "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"; // Put your token here
    const OWNER = "Chukort";               // Put your GitHub username here
    const REPO = "GAM";               // Put your repo name here
    const FILE_PATH = "database.json";           // Same folder as this file

    function toggleOtherChurch(value) {
        const otherDiv = document.getElementById('otherDiv');
        if (value === 'Other') {
            otherDiv.classList.remove('hidden');
            otherDiv.style.display = 'block';
            document.getElementById('customChurch').focus();
        } else {
            otherDiv.classList.add('hidden');
            otherDiv.style.display = 'none';
        }
    }

    function addRow() {
        const list = document.getElementById('list');
        const div = document.createElement('div');
        div.className = 'participant-entry';
        div.style.marginTop = "12px";
        div.style.animation = "slideInLeft 0.3s ease-out";
        div.innerHTML = `
            <input type="text" class="p-name" placeholder="Full Name" required>
            <button class="btn btn-remove" onclick="this.parentElement.remove()" title="Remove Entry">âœ•</button>
        `;
        list.appendChild(div);
        div.querySelector('input').focus();
    }

async function saveData() {
    const btn = document.getElementById('submitBtn');
    const churchSelect = document.getElementById('churchSelect');
    let church = churchSelect.value === 'Other' ? document.getElementById('customChurch').value.trim() : churchSelect.value;
    
    if (!church) return alert("Please select a church.");

    const nameInputs = document.querySelectorAll('.p-name');
    let newEntries = [];
    nameInputs.forEach(input => {
        if (input.value.trim()) {
            newEntries.push({
                church: church.toUpperCase(),
                name: input.value.trim().toUpperCase(),
                date: new Date().toLocaleDateString()
            });
        }
    });

    btn.disabled = true;
    btn.innerText = "Connecting...";

    try {
        // We add a timestamp to the URL to force GitHub to give us the LATEST SHA
        const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}?t=${new Date().getTime()}`;
        
        const res = await fetch(url, {
            headers: { "Authorization": `token ${GITHUB_TOKEN}` }
        });

        if (!res.ok) throw new Error("Database file not found on GitHub. Create database.json with [] first.");

        const fileData = await res.json();
        const sha = fileData.sha; 
        const currentData = JSON.parse(decodeURIComponent(escape(atob(fileData.content))));

        const updatedData = [...currentData, ...newEntries];
        const updatedContent = btoa(unescape(encodeURIComponent(JSON.stringify(updatedData, null, 2))));

        const putRes = await fetch(url, {
            method: "PUT",
            headers: {
                "Authorization": `token ${GITHUB_TOKEN}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                message: `Add ${newEntries.length} from ${church}`,
                content: updatedContent,
                sha: sha 
            })
        });

        if (putRes.ok) {
            document.getElementById('successModal').classList.add('active');
        } else {
            const errorInfo = await putRes.json();
            throw new Error(errorInfo.message);
        }

    } catch (err) {
        console.error(err);
        alert("Rejected: " + err.message);
        btn.disabled = false;
        btn.innerText = "Submit Registration";
    }
}

    function closeModal() {
        document.getElementById('successModal').classList.remove('active');
        setTimeout(() => { location.reload(); }, 400);
    }
</script>

</body>

</html>
